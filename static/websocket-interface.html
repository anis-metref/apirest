<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <title>Ansible WebSocket Interface</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-[#101a23] dark group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            
            <!-- Header -->
            <h2 class="text-white tracking-light text-[28px] font-bold leading-tight px-4 text-center pb-3 pt-5">Ansible WebSocket Interface</h2>
            <p class="text-white text-base font-normal leading-normal pb-3 pt-1 px-4 text-center">Installation Apache en temps reel via WebSocket</p>
            
            <!-- API Key Configuration -->
            <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Configuration Cle API</h2>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <input
                  type="password"
                  id="apiKey"
                  placeholder="*****"
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border border-[#314d68] bg-[#182634] focus:border-[#314d68] h-14 placeholder:text-[#90adcb] p-[15px] text-base font-normal leading-normal"
                  value=""
                />
              </label>
            </div>
            <div class="flex px-4 py-3 justify-start">
              <button
                id="testBtn"
                onclick="testApiKey()"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#0d80f2] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#0b6bc7]"
              >
                <span class="truncate">Tester</span>
              </button>
            </div>
            <p id="apiStatus" class="text-[#90adcb] text-sm font-normal leading-normal pb-3 pt-1 px-4">Entrez votre cle API pour acceder aux fonctions securisees.</p>
            
            <!-- Action Buttons -->
            <div class="flex justify-stretch">
              <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-start">
                <button
                  id="installBtn"
                  onclick="startInstall()"
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#0d80f2] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#0b6bc7]"
                >
                  <span class="truncate">Installer Apache</span>
                </button>
                <button
                  onclick="clearOutput()"
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#223649] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#2a4356]"
                >
                  <span class="truncate">Effacer</span>
                </button>
                <button
                  onclick="checkInventory()"
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#223649] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#2a4356]"
                >
                  <span class="truncate">Voir Inventaire</span>
                </button>
              </div>
            </div>
            
            <!-- Status -->
            <p id="status" class="text-[#90adcb] text-sm font-normal leading-normal pb-3 pt-1 px-4">Pret a installer Apache. Cliquez sur le bouton pour commencer.</p>
            
            <!-- Console Output -->
            <div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-white text-base font-medium leading-normal pb-2">Console de sortie</p>
                <div
                  id="output"
                  class="flex flex-col w-full min-w-0 flex-1 overflow-y-auto rounded-lg text-green-400 border-none bg-[#0a0a0a] min-h-96 p-4 text-sm font-mono leading-normal"
                  style="max-height: 400px;"
                >
                  <div style="color: #888;">[En attente] Console d'installation - En attente...</div>
                </div>
              </label>
            </div>
            
          </div>
        </div>
      </div>
    </div>

    <script>
        // Fonction pour obtenir la cle API
        function getApiKey() {
            return document.getElementById('apiKey').value || '';
        }
        
        // Fonction pour tester la cle API
        async function testApiKey() {
            const apiKey = getApiKey();
            const apiStatus = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testBtn');
            
            if (!apiKey) {
                apiStatus.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                apiStatus.innerHTML = 'Veuillez entrer une cle API.';
                return;
            }
            
            testBtn.innerHTML = '<span class="truncate">Test...</span>';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('/inventory', {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (response.ok) {
                    apiStatus.className = 'text-green-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                    apiStatus.innerHTML = 'Cle API valide ! Vous pouvez utiliser toutes les fonctions.';
                } else {
                    apiStatus.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                    apiStatus.innerHTML = 'Cle API invalide. Verifiez votre cle.';
                }
            } catch (error) {
                apiStatus.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                apiStatus.innerHTML = 'Erreur de connexion au serveur.';
            }
            
            testBtn.innerHTML = '<span class="truncate">Tester</span>';
            testBtn.disabled = false;
        }
        
        // Fonction pour verifier l'inventaire
        async function checkInventory() {
            const apiKey = getApiKey();
            const output = document.getElementById('output');
            
            if (!apiKey) {
                addToOutput('Cle API requise pour voir l\'inventaire', 'text-red-400');
                return;
            }
            
            try {
                addToOutput('Recuperation de l\'inventaire...', 'text-cyan-400');
                const response = await fetch('/inventory', {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addToOutput('Inventaire recupere avec succes:', 'text-green-400');
                    addToOutput(JSON.stringify(data, null, 2), 'text-yellow-400');
                } else {
                    const error = await response.json();
                    addToOutput(`Erreur: ${error.detail}`, 'text-red-400');
                }
            } catch (error) {
                addToOutput(`Erreur de connexion: ${error.message}`, 'text-red-400');
            }
        }
        
        function startInstall() {
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            const btn = document.getElementById('installBtn');
            const apiKey = getApiKey();
            
            // Verifier si la cle API est fournie
            if (!apiKey) {
                addToOutput('Cle API requise pour l\'installation', 'text-red-400');
                status.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                status.innerHTML = 'Cle API manquante - Entrez votre cle API d\'abord';
                return;
            }
            
            output.innerHTML = '<div class="text-cyan-400">Connexion au WebSocket...</div>';
            status.className = 'text-blue-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
            status.innerHTML = 'Installation en cours...';
            btn.disabled = true;
            btn.innerHTML = '<span class="truncate">Installation...</span>';
            
            // Detection automatique du protocole (HTTP/HTTPS)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host || 'localhost:8000';
            const wsUrl = `${protocol}//${host}/ws/install-apache`;
            
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                addToOutput('Connexion WebSocket etablie', 'text-cyan-400');
                // Envoyer la cle API pour l'authentification
                ws.send(JSON.stringify({
                    type: "auth",
                    api_key: apiKey
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.status === 'authenticated') {
                    addToOutput(`${data.message}`, 'text-green-400');
                } else if (data.status === 'start') {
                    addToOutput(`${data.message}`, 'text-yellow-400');
                } else if (data.status === 'success') {
                    addToOutput(`${data.message}`, 'text-green-400');
                    status.className = 'text-green-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                    status.innerHTML = 'Installation reussie !';
                } else if (data.status === 'error') {
                    addToOutput(`${data.message}`, 'text-red-400');
                    status.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                    status.innerHTML = 'Erreur lors de l\'installation';
                } else if (data.output) {
                    addToOutput(data.output, 'text-green-400');
                } else if (data.error) {
                    addToOutput(`ERREUR: ${data.error}`, 'text-red-400');
                    if (data.help) {
                        addToOutput(`Solution: ${data.help}`, 'text-yellow-400');
                    }
                    status.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                    status.innerHTML = 'Erreur - Verifiez la console';
                }
            };
            
            ws.onclose = function() {
                addToOutput('Connexion fermee', 'text-gray-400');
                btn.disabled = false;
                btn.innerHTML = '<span class="truncate">Installer Apache</span>';
            };
            
            ws.onerror = function() {
                addToOutput('Erreur de connexion WebSocket', 'text-red-400');
                status.className = 'text-red-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
                status.innerHTML = 'Erreur de connexion';
                btn.disabled = false;
                btn.innerHTML = '<span class="truncate">Installer Apache</span>';
            };
        }
        
        function addToOutput(message, colorClass = 'text-green-400') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = colorClass;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            output.innerHTML = '<div class="text-gray-400">[Efface] Console effacee - Pret pour une nouvelle installation...</div>';
            status.className = 'text-blue-400 text-sm font-normal leading-normal pb-3 pt-1 px-4';
            status.innerHTML = 'Console effacee. Pret a installer Apache.';
        }
    </script>
</body>
</html>
